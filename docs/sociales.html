---
title: Sociales
layout: default
nav_order: 2
page_toc: false
permalink: /sociales/
js:
  - "https://cdn.anychart.com/releases/v8/js/anychart-base.min.js"
  - "https://cdn.anychart.com/releases/v8/js/anychart-tag-cloud.min.js"
  - "//cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"
css:
  - "//cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css"
  - "//rawgit.com/vitmalina/w2ui/master/dist/w2ui.min.css"
---

<div id="years" style="height: 150px;"></div>
<div id="tags" style="height: 300px;"></div>

<div id="main" style="width: 100%; height: 800px;"></div>

<script type="module">
  import { w2layout, w2sidebar, w2grid, w2form, w2utils, query } from 'https://rawgit.com/vitmalina/w2ui/master/dist/w2ui.es6.min.js'

  let grid = new w2grid({
    name: 'grid',
    box: "#main",
    show: {
      footer: true,
      toolbar: true,
      lineNumbers : true
    },
    method: 'GET',
    columns: [
        { field: 'title', text: 'Titulo', size: '50%',  resizable: true, sortable: true, searchable: 'text',
          render: function(record) {
            return `<a href="${record.url}" target="_blank">${record.title}</a>`
          }
        },
        { field: 'tags', text: 'Temas', size: '35%',  resizable: true, sortable: true, searchable: 'text',
          render: function(record) {
            // render each tag as a span with the class 'tag'
            return record.tags.map(tag => `<span class="tag">${tag}</span>`).join(' ')
          }
        },
        { field: 'year', text: 'AÃ±o', size: '60px', sortable: true, searchable: 'int', style: 'text-align: center' }
    ],
    //fixedBody: false,
    recid: "id",
    statusRecordID: false,
    textSearch: 'contains'
  });

  window.grid = grid;

  fetch('https://menosrelato.blob.core.windows.net/conicet/192-CIENCIAS_SOCIALES.json')
    .then(response => response.json())
    .then(data => {
      window.data = data;
      grid.records = data;
      grid.sort('year', 'desc');
      grid.reload();

      window.year = null;
      window.tag = null;

      createClouds();
    });

</script>

<script>
function createClouds() {
  let cloudData = prepareCloudData();
  var data = cloudData.years.items.map(function (word) { return { x: word.text, percent: Math.round(word.weight * 100) / 100, value: word.count }; });

  var chart = anychart.tagCloud(data);
  chart.angles([0])

  {% raw %}
  var tooltip = chart.tooltip();
  tooltip.format("{%value} publicaciones");
  {% endraw %}

  chart.listen("pointClick", function(e){
    filterYear(e.point.get("x"));
  });

  $('#years').empty();
  chart.container("years");
  chart.draw();

  // append div elements for each cloud, using plain DOM to add to the clouds div
  // generate random ids for each div, so we can use them to create the clouds
  // var clouds = document.getElementById('clouds');  
  // clouds.childNodes.forEach(child => child.remove());

  // var yid = Math.random();

  // var yd = document.createElement("div");
  // yd.id = yid;
  // clouds.appendChild(yd);

  // $("<div id='" + yid + "'/>").appendTo("#clouds").jQCloud(cloudData.years.items, {
  //     autoResize: true,
  //     delay: 50,
  //     shape: 'rectangular',
  //     height: (300 + (100 * cloudData.years.big)),
  //     removeOverflowing: false
  // });

  // var tid = Math.random();
  // var td = document.createElement("div");
  // td.id = tid;
  // clouds.appendChild(td);

  // $("#tags").jQCloud(cloudData.tags.items, {
  //     autoResize: true,
  //     delay: 50,
  //     shape: 'rectangular',
  //     height: (400 + (100 * cloudData.tags.big)),
  //     removeOverflowing: false
  // }); 

  data = cloudData.tags.items.map(function (word) { return { x: word.text, percent: Math.round(word.weight * 100) / 100, value: word.count }; });  
  data.sort((a, b) => b.value - a.value);
  data = data.slice(0, 50);
  chart = anychart.tagCloud(data);
  chart.angles([0])
  chart.textSpacing(5);
  //chart.scale(anychart.scales.log());

  {% raw %}
  var tooltip = chart.tooltip();
  tooltip.format("{%value} publicaciones");
  {% endraw %}

  chart.listen("pointClick", function(e){
    filterTag(e.point.get("x"));
  });

  $('#tags').empty();
  chart.container("tags");
  chart.draw();
}

function updateClouds() {
  // $('#years').jQCloud('destroy');
  // $('#years').empty();
  // $('#tags').jQCloud('destroy');
  // $('#tags').empty();

  createClouds();
  // let cloudData = prepareCloudData();

  // var data = cloudData.years.items.map(function (word) { return { x: word.text, percent: Math.round(word.weight * 100) / 100, value: word.count }; });

  // var chart = anychart.tagCloud(data);
  // chart.angles([0])

  // {% raw %}
  // var tooltip = chart.tooltip();
  // tooltip.format("{%value} publicaciones");
  // {% endraw %}

  // chart.listen("pointClick", function(e){
  //   filterYear(e.point.get("x"));
  // });

  // // display the word cloud chart
  // $('#years').empty();
  // chart.container("years");
  // chart.draw();

  // // // $('#years').jQCloud(cloudData.years.items);
  // $('#tags').jQCloud(cloudData.tags.items);
}

function prepareCloudData() {
  let years = {};
  let tags = {};

  data.forEach(item => {
    if (!window.tag || item.tags.includes(window.tag)) {
      years[item.year] = (years[item.year] || 0) + 1;
    }

    if (!window.year || item.year === window.year) {
      item.tags.forEach(tag => {
        tags[tag] = (tags[tag] || 0) + 1;
      });
    }
  });

  let filtered = data;
  if (window.year) {
    filtered = filtered.filter(item => item.year == window.year);
  }
  if (window.tag) {
    filtered = filtered.filter(item => item.tags.includes(window.tag));
  }
  let total = filtered.length;

  let yearArray = Object.entries(years).map(([text, count]) => {
    var word = { text, count, weight: (count / total) * 100, link: "#", handlers: {
      click: function() {
        filterYear(text);
    }}};

    if (window.year && text === window.year) {
      word.html = { 'selected': true };
    }

    return word;
  });

  let tagArray = Object.entries(tags).map(([text, count]) => {
    var word = { text, count, weight: (count / total) * 100, link: "#", handlers: {
      click: function() {
        filterTag(text);
    }}};

    if (window.tag && text == window.tag) {
      word.html = { 'selected': true };
    }

    return word;
  });

  var isBig = function(weight) { return weight >= 40 }; 
  var bigYear = yearArray.map(function (word) { return word.weight }).filter(isBig).length;
  var bigTag = tagArray.map(function (word) { return word.weight }).filter(isBig).length;

  return { 
    years: {
      items: yearArray,
      big: bigYear
    }, 
    tags: {
      items: tagArray,
      big: bigTag
    } 
  };
}

function filterYear(value) {
  // parse value as an integer
  window.year = parseInt(value);
  doSearch();
}

function filterTag(value) {
  window.tag = value;
  doSearch();
}

function doSearch() {
  var searches = [];
  if (tag) {
    searches.push({ field: 'tags', operator: 'contains', value: tag });
  }

  if (year) {
    searches.push({ field: 'year', operator: 'is', value: year });
  }

  grid.search(searches, 'AND');
  updateClouds();
}

</script>